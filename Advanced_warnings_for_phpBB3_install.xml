<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http
://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.2.xsd">
    <header>
        <title lang="en">Advanced warnings system for phpBB3</title>
        <description lang="en">This mod changes built-in phpBB3 warnings system to the more advanced one.</description>
        <author-notes lang="en"></author-notes>
        <author-group>
            <author>
                <realname></realname>
                <username>rxu</username>
                <email>rxu@mail.ru</email>
                <homepage>http://phpbbguru.net/community/</homepage>
                <contributions status="" from="2008-02-06" to="2009-01-05"></contributions>
            </author>
        </author-group>
        <mod-version>0.9b</mod-version>
        <installation>
            <level>intermediate</level>
            <time>2100</time>
            <target-version>3.0.4</target-version>
        </installation>
        <history>
            <entry>
                <date>2008-02-06</date>
                <rev-version>0.1b</rev-version>
                <changelog lang="en">
                    <change>Initial release</change>
                </changelog>
            </entry>
            <entry>
                <date>2008-02-07</date>
                <rev-version>0.3b</rev-version>
                <changelog lang="en">
                    <change>ACP settings for warnings pruning time and ban by X warnings are added.</change>
                </changelog>
            </entry>
            <entry>
                <date>2008-02-08</date>
                <rev-version>0.5b</rev-version>
                <changelog lang="en">
                    <change>Warnings notices in posts are added; subsilver2 MOD instruction is added; warning end date in edit warning mode is added; more minor code changes.</change>
                </changelog>
            </entry>
            <entry>
                <date>2008-02-15</date>
                <rev-version>0.7b</rev-version>
                <changelog lang="en">
                    <change>User notification by email or/and Jabber about warning issue/edit is added. Warnings/ban information in users' miniprofiles at viewtopic is added. Warnings list in users' profiles is added. Automatic user unban when warnings count becomes less than it's needed for ban is added. SQL query caching in viewtopic is added. Minor bugs fixes.</change>
                </changelog>
            </entry>
            <entry>
                <date>2009-03-09</date>
                <rev-version>0.9b</rev-version>
                <changelog lang="en">
                    <change>Final release tag. Installation is optimized. Language file is added. Minor code modification for phpBB 3.0.4 compliance. Minor bugs fixes.</change>
                </changelog>
            </entry>
        </history>
        <meta>Generated by ModX Editor v1.0.0-alpha1</meta>
        <license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
		<link-group>
			<link type="template" href="subsilver2.xml" lang="en">subsilver2</link>
			<link type="language" href="ru.xml" lang="en">Russian</link>
		</link-group>
    </header>
    <action-group>
		<sql><![CDATA[ALTER TABLE phpbb_users ADD user_ban_id mediumint(8) UNSIGNED DEFAULT '0' NOT NULL;
ALTER TABLE phpbb_warnings ADD warning_end int(11) UNSIGNED DEFAULT '0' NOT NULL;
ALTER TABLE phpbb_warnings ADD warning_type tinyint(1) UNSIGNED DEFAULT '0' NOT NULL;
ALTER TABLE phpbb_warnings ADD warning_status tinyint(1) UNSIGNED DEFAULT '1' NOT NULL;
INSERT INTO phpbb_config (config_name, config_value) VALUES ('warnings_for_ban', '3'); ]]></sql>
        <copy>
            <!--A_Jelly_Donut said this is enough to copy all files from root/ recursively
especially the to="*.*" part!--><file from="root/language/en/*.*" to="language/en/*.*"></file>
        </copy>
        <open src="memberlist.php">
            <edit>
                <find>		$template-&gt;assign_vars(show_profile($member));</find>
                <action type="after-add">		// Warnings list
		$user-&gt;add_lang(array('acp/ban', 'mods/warnings'));
		$sql = 'SELECT w.warning_id, w.post_id, w.warning_time, w.warning_end, w.warning_type, w.warning_status, l.user_id, l.log_data, l.reportee_id, u.username, u.user_colour 
			FROM ' . WARNINGS_TABLE . ' w, ' . LOG_TABLE . ' l, ' . USERS_TABLE . &quot; u  
				WHERE w.user_id = $user_id 
					AND l.log_id = w.log_id
					AND u.user_id = l.user_id
						ORDER BY w.warning_status DESC, w.warning_id DESC&quot;;

		$result = $db-&gt;sql_query($sql);

		$warning = array();
		while ($row = $db-&gt;sql_fetchrow($result))
		{
			if (!$auth-&gt;acl_get('m_warn') &amp;&amp; !$row['warning_status'])
			{
				continue;
			}

			$warning = unserialize($row['log_data']);

			$template-&gt;assign_block_vars('user', array(
				'U_EDIT'			=&gt; ($auth-&gt;acl_get('m_warn')) ? append_sid(&quot;{$phpbb_root_path}mcp.$phpEx&quot;, 'i=warn&amp;amp;mode=' . (($row['post_id']) ? 'warn_post&amp;amp;p=' . $row['post_id'] : 'warn_user') . '&amp;amp;u=' . $user_id . '&amp;amp;warn_id=' . $row['warning_id']) : '',

				'USERNAME_FULL'		=&gt; get_username_string('full', $row['user_id'], $row['username'], $row['user_colour']),
				'USERNAME_COLOUR'	=&gt; ($row['user_colour']) ? '#' . $row['user_colour'] : '',
			
				'WARNING_TIME'		=&gt; ($row['warning_end']) ? $user-&gt;format_date($row['warning_end']) : $user-&gt;lang['PERMANENT'],
				'WARNING'			=&gt; $warning[0],
				'WARNINGS'			=&gt; $user-&gt;format_date($row['warning_time']),
				'WARNING_STATUS'	=&gt; ($row['warning_status']) ? true : false,
				'U_WARNING_POST_URL'=&gt; ($row['post_id']) ? append_sid(&quot;{$phpbb_root_path}viewtopic.$phpEx&quot;, 'p=' . $row['post_id'] . '#p' . $row['post_id']) : '',
			));
		}
		$db-&gt;sql_freeresult($result);

</action>
            </edit>
        </open>
        <open src="viewtopic.php">
            <edit>
                <find>				'from'			=&gt; '',</find>
                <action type="after-add">				'user_ban_id'	=&gt; '',</action>
            </edit>
            <edit>
                <find>				'warnings'		=&gt; (isset($row['user_warnings'])) ? $row['user_warnings'] : 0,</find>
                <action type="after-add">				'user_ban_id'	=&gt; (isset($row['user_ban_id'])) ? $row['user_ban_id'] : 0,</action>
            </edit>
            <edit>
                <find>// Instantiate BBCode if need be</find>
                <action type="before-add">//Pull warnings data
$user-&gt;add_lang(array('acp/ban', 'mods/warnings'));
$warnings = $users_banned = array();
$sql = 'SELECT w.post_id, w.warning_time, w.warning_end, w.warning_type, w.warning_status, l.user_id, l.log_data, l.reportee_id, u.username, u.user_colour 
	FROM ' . WARNINGS_TABLE . ' w, ' . LOG_TABLE . ' l, ' . USERS_TABLE . ' u  
		WHERE w.warning_status = 1
			AND l.log_id = w.log_id
			AND u.user_id = l.user_id';

$result = $db-&gt;sql_query($sql, 86400);

while ($row = $db-&gt;sql_fetchrow($result))
{
	if($row['post_id'])
	{
		$warnings[$row['post_id']] = array(
			'warning_time'	=&gt; $row['warning_time'],
			'warning_end'	=&gt; $row['warning_end'],
			'warning_type'	=&gt; $row['warning_type'],
			'user_id'		=&gt; $row['user_id'],
			'username'		=&gt; $row['username'],
			'user_colour'	=&gt; $row['user_colour'],
			'warning'		=&gt; unserialize($row['log_data'])
		);
	}

	if($row['warning_type'] == BAN)
	{
		$users_banned[$row['reportee_id']] = array(
			'warning_end'	=&gt; $row['warning_end']
		);
	}
}
$db-&gt;sql_freeresult($result);

</action>
            </edit>
            <edit>
                <find>		'BUMPED_MESSAGE'	=&gt; $l_bumped_by,</find>
                <action type="after-add">		
		'WARNING'			=&gt; isset($warnings[$row['post_id']]) ? bbcode_nl2br($warnings[$row['post_id']]['warning'][0]) : '',
		'WARNING_POSTER'	=&gt; isset($warnings[$row['post_id']]) ? get_username_string('full', $warnings[$row['post_id']]['user_id'], $warnings[$row['post_id']]['username'], $warnings[$row['post_id']]['user_colour']) : '',
		'WARNING_TIME'		=&gt; isset($warnings[$row['post_id']]) ? $user-&gt;format_date($warnings[$row['post_id']]['warning_time']) : '',
		'WARNING_TYPE'		=&gt; isset($warnings[$row['post_id']]) ? $warnings[$row['post_id']]['warning_type'] : '',
		'POSTER_BANNED'		=&gt; ($user_cache[$poster_id]['user_ban_id']) ? true : ((isset($users_banned[$poster_id])) ? true : false),
		'POSTER_BAN_END'	=&gt; ($user_cache[$poster_id]['user_ban_id']) ? sprintf($user-&gt;lang['BANNED_BY_X_WARNINGS'], $config['warnings_for_ban']) : ((isset($users_banned[$poster_id])) ? (($users_banned[$poster_id]['warning_end'] &gt; 0) ? sprintf($user-&gt;lang['BANNED_UNTIL'], $user-&gt;format_date($users_banned[$poster_id]['warning_end'])) : $user-&gt;lang['BANNED_PERMANENTLY']) : ''),

</action>
            </edit>
        </open>
        <open src="includes/constants.php">
            <edit>
                <find>define('VOTE_CONVERTED', 127);</find>
                <action type="after-add">define('WARNING', 0);
define('BAN', 1);
define('WARNING_BAN', 2);
</action>
            </edit>
        </open>
        <open src="includes/functions_admin.php">
            <edit>
                <find>	// Adjust users post counts</find>
				<action type="before-add">	// Adjust warning given for deleted post
	$sql = 'UPDATE ' . WARNINGS_TABLE . ' 
		SET post_id = 0
		WHERE ' . $db->sql_in_set('post_id', $post_ids);
	$db->sql_query($sql);
</action>
                <find>/**
* Get database size
* Currently only mysql and mssql are supported
*/
</find>
                <action type="before-add">/**
* Lists warnings
*/
function view_warnings_list(&amp;$users, &amp;$user_count, $limit = 0, $offset = 0, $limit_days = 0, $sort_by = 'warning_time DESC')
{
	global $db;

	$sql = 'SELECT u.user_id, u.username, u.user_colour, u.user_warnings, u.user_last_warning, w.warning_id, w.warning_time, w.warning_end, w.warning_status, w.post_id
		FROM ' . USERS_TABLE . ' u, ' . WARNINGS_TABLE . ' w
		WHERE u.user_id = w.user_id
		' . (($limit_days) ? &quot;AND w.warning_time &gt;= $limit_days&quot; : '') . '
		ORDER BY ' . ((strstr($sort_by, 'user')) ? 'u.' : 'w.') . $sort_by;
	$result = $db-&gt;sql_query_limit($sql, $limit, $offset);
	$users = $db-&gt;sql_fetchrowset($result);
	$user_count = sizeof($users);
	$db-&gt;sql_freeresult($result);

	return;
}

</action>
            </edit>
            <edit>
                <find>function tidy_warnings()</find>
                <find>	global $db, $config;</find>
                <action type="replace-with">	global $db, $config, $cache, $phpbb_root_path, $phpEx;</action>
            </edit>
            <edit>
                <find>	$warning_list = $user_list = array();</find>
                <action type="replace-with">	$warning_list = $user_list = $unban_list = array();</action>
                <action type="after-add">	$current_time = time();
	</action>
            </edit>
            <edit>
                <find>		WHERE warning_time &lt; $expire_date&quot;;</find>
                <action type="replace-with">		WHERE warning_end &lt; $current_time 
			AND warning_end &gt; 0 
			AND warning_status = 1&quot;;
</action>
            </edit>
            <edit>
                <find>		$sql = 'DELETE FROM ' . WARNINGS_TABLE . '</find>
                <action type="replace-with">		$sql = 'UPDATE ' . WARNINGS_TABLE . ' SET warning_status = 0</action>
            </edit>
            <edit>
                <find>		$db-&gt;sql_transaction('commit');</find>
                <action type="after-add">		$sql = 'SELECT user_ban_id FROM ' . USERS_TABLE . ' 
			WHERE user_ban_id &lt;&gt; 0 
				AND user_warnings &lt; ' . $config['warnings_for_ban'];
		$result = $db-&gt;sql_query($sql);
		while($row = $db-&gt;sql_fetchrow($result))
		{
			$unban_list[] = $row['user_ban_id'];
		}
		$db-&gt;sql_freeresult($result);

		if(sizeof($unban_list))
		{
			$sql = 'UPDATE ' . USERS_TABLE . ' SET user_ban_id = 0
				WHERE ' . $db-&gt;sql_in_set('user_ban_id', $unban_list);
			$db-&gt;sql_query($sql);

			if(!function_exists('user_unban'))
			{
				include_once($phpbb_root_path . 'includes/functions_user.' . $phpEx);
			}
			user_unban('user', $unban_list);
		}
</action>
            </edit>
            <edit>
                <find>	set_config('warnings_last_gc', time(), true);</find>
                <action type="before-add">	$cache-&gt;destroy('sql', WARNINGS_TABLE);</action>
            </edit>
        </open>
        <open src="includes/functions_user.php">
            <edit>
                <find>		$sql = 'DELETE FROM ' . BANLIST_TABLE . '</find>
                <action type="before-add">		// Change unban list related warnings type
		$warning_list = array();
		$sql = 'SELECT w.warning_id FROM ' . WARNINGS_TABLE . ' w, ' . BANLIST_TABLE . ' b 
					WHERE w.warning_end = b.ban_end
						AND ' . $db->sql_in_set('b.ban_id', $unban_sql);
		$result = $db->sql_query($sql);
		while ($row = $db->sql_fetchrow($result))
		{
			$warning_list[] = $row['warning_id'];
		}
		$db->sql_freeresult($result);

		if(sizeof($warning_list))
		{
			$sql = 'UPDATE ' . WARNINGS_TABLE . ' SET warning_type = ' . WARNING . ' 
						WHERE ' . $db->sql_in_set('warning_id', $warning_list);
			$db->sql_query($sql);
			$cache->destroy('sql', WARNINGS_TABLE);
		}</action>
            </edit>
        </open>
        <open src="includes/acp/acp_board.php">
            <edit>
                <find>		$user-&gt;add_lang('acp/board');</find>
                <action type="replace-with">		$user-&gt;add_lang(array('acp/board', 'mods/warnings'));</action>
            </edit>
            <edit>
                <find>						'warnings_expire_days'	=&gt; array('lang' =&gt; 'WARNINGS_EXPIRE',		'validate' =&gt; 'int',	'type' =&gt; 'text:3:4', 'explain' =&gt; true, 'append' =&gt; ' ' . $user-&gt;lang['DAYS']),</find>
                <action type="replace-with">//						'warnings_expire_days'	=&gt; array('lang' =&gt; 'WARNINGS_EXPIRE',		'validate' =&gt; 'int',	'type' =&gt; 'text:3:4', 'explain' =&gt; true, 'append' =&gt; ' ' . $user-&gt;lang['DAYS']),
						'warnings_for_ban'		=&gt; array('lang' =&gt; 'WARNINGS_FOR_BAN',		'validate' =&gt; 'int',	'type' =&gt; 'text:1:2', 'explain' =&gt; true),
						'warnings_gc'			=&gt; array('lang' =&gt; 'WARNINGS_GC',			'validate' =&gt; 'int',	'type' =&gt; 'text:4:5', 'explain' =&gt; true, 'append' =&gt; ' ' . $user-&gt;lang['SECONDS']),
</action>
            </edit>
        </open>
        <open src="includes/mcp/mcp_warn.php">
            <edit>
                <find>		add_form_key('mcp_warn');</find>
                <action type="after-add">		$user-&gt;add_lang(array('acp/ban', 'mods/warnings'));</action>
            </edit>
            <edit>
                <find>		$sort_by_sql = array('a' =&gt; 'username_clean', 'b' =&gt; 'user_last_warning', 'c' =&gt; 'user_warnings');</find>
                <action type="replace-with">		$sort_by_sql = array('a' =&gt; 'username_clean', 'b' =&gt; 'warning_time', 'c' =&gt; 'user_warnings');</action>
            </edit>
            <edit>
                <find>		view_warned_users($users, $user_count, $config['topics_per_page'], $start, $sql_where, $sql_sort);</find>
                <action type="replace-with">		view_warnings_list($users, $user_count, $config['topics_per_page'], $start, $sql_where, $sql_sort);</action>
            </edit>
            <edit>
                <find>				'WARNING_TIME'	=&gt; $user-&gt;format_date($row['user_last_warning']),
				'WARNINGS'		=&gt; $row['user_warnings'],
</find>
                <action type="replace-with">				'WARNING_TIME'		=&gt; ($row['warning_end']) ? $user-&gt;format_date($row['warning_end']) : $user-&gt;lang['PERMANENT'],
				'WARNINGS'			=&gt; $user-&gt;format_date($row['warning_time']),
				'WARNING_STATUS'	=&gt; ($row['warning_status']) ? true : false,
				'U_WARNING_POST_URL'=&gt; ($row['post_id']) ? append_sid(&quot;{$phpbb_root_path}viewtopic.$phpEx&quot;, 'p=' . $row['post_id'] . '#p' . $row['post_id']) : '',
				'U_EDIT'			=&gt; ($auth-&gt;acl_get('m_warn')) ? append_sid(&quot;{$phpbb_root_path}mcp.$phpEx&quot;, 'i=warn&amp;amp;mode=' . (($row['post_id']) ? 'warn_post&amp;amp;p=' . $row['post_id'] : 'warn_user') . '&amp;amp;u=' . $row['user_id'] . '&amp;amp;warn_id=' . $row['warning_id']) : '',
</action>
            </edit>
            <edit>
                <find>			'TOTAL_USERS'		=&gt; ($user_count == 1) ? $user-&gt;lang['LIST_USER'] : sprintf($user-&gt;lang['LIST_USERS'], $user_count),</find>
                <action type="replace-with">			'TOTAL_WARNINGS'	=&gt; ($user_count == 1) ? $user-&gt;lang['LIST_WARNING'] : sprintf($user-&gt;lang['LIST_WARNINGS'], $user_count),</action>
            </edit>
            <edit>
                <find>		$warning = utf8_normalize_nfc(request_var('warning', '', true));</find>
                <action type="after-add">		$warn_len = request_var('warnlength', 0);
		$warn_len_other	= request_var('warnlengthother', '');
		$warn_type = request_var('warntype', WARNING);
		$warning_id = request_var('warn_id', 0);
</action>
            </edit>
            <edit>
                <find>		// Prevent someone from warning themselves
		if ($user_row['user_id'] == $user-&gt;data['user_id'])
		{
			trigger_error('CANNOT_WARN_SELF');
		}
</find>
                <action type="after-add">		// Prevent someone from warning founder
		if ($user_row['user_type'] == USER_FOUNDER)
		{
			trigger_error('CANNOT_WARN_FOUNDER');
		}
</action>
            </edit>
            <edit>
                <find>		if ($row)</find>
                <action type="replace-with">		if ($row &amp;&amp; !$warning_id)</action>
            </edit>
            <edit>
                <find>		$user_id = $user_row['user_id'];</find>
                <action type="after-add">		$warning_edit = array();
		if ($warning_id)
		{
			$sql = 'SELECT w.*, l.log_data
				FROM ' . WARNINGS_TABLE . ' w, ' . LOG_TABLE . &quot; l 
				WHERE w.warning_id = '$warning_id'
					AND l.log_id = w.log_id&quot;;
			$result = $db-&gt;sql_query($sql);
			$warning_row = $db-&gt;sql_fetchrow($result);
			$db-&gt;sql_freeresult($result);

			if (!$warning_row)
			{
				trigger_error('NO_WARNING');
			}
			
			if (!$warning_row['warning_status'])
			{
				trigger_error('WARNING_EXPIRED');
			}
			
			$warning_edit = unserialize($warning_row['log_data']);
			$forum_id = $user_row['forum_id'];
		}

</action>
            </edit>
            <edit>
                <find>		if ($warning &amp;&amp; $action == 'add_warning')</find>
                <action type="before-add">		
		if (!$warning_id &amp;&amp; !$user_row['user_ban_id'] &amp;&amp; ($user_row['user_warnings'] + 1 == $config['warnings_for_ban']))
		{
			$warn_type = WARNING_BAN;
			$warning = sprintf($user-&gt;lang['WARNING_BAN'], ($user_row['user_warnings'] + 1), $warning);
		}

</action>
            </edit>
            <edit>
                <find>				add_warning($user_row, $warning, $notify, $post_id);
				$msg = $user-&gt;lang['USER_WARNING_ADDED'];
</find>
                <action type="replace-with">				if (!function_exists('user_ban'))
				{
					include_once($phpbb_root_path . 'includes/functions_user.' . $phpEx);
				}
				if ($warning_id)
				{
					edit_warning($warning_row, $user_row, $warning, $warn_len, $warn_len_other, $warn_type);
					$msg = $user-&gt;lang['USER_WARNING_EDITED'] . (($warn_type == BAN) ? '&lt;br /&gt;&lt;br /&gt;' . $user-&gt;lang['BAN_UPDATE_SUCCESSFUL'] : '');
					$email_template = 'warning_edited';
				}
				else
				{
					add_warning($user_row, $warning, $warn_len, $warn_len_other, $warn_type, $notify, $post_id);
					$msg = $user-&gt;lang['USER_WARNING_ADDED'];
					$email_template = 'warning_post';

					if ($warn_type == BAN)
					{
						$ban = utf8_normalize_nfc($user_row['username']);
						user_ban('user', $ban, $warn_len, $warn_len_other, 0, $warning, $warning);
						$msg .= '&lt;br /&gt;&lt;br /&gt;' . $user-&gt;lang['BAN_UPDATE_SUCCESSFUL'];
						$email_template = 'warning_post_ban';
					}
					else if($warn_type == WARNING_BAN)
					{
						$ban = utf8_normalize_nfc($user_row['username']);
						user_ban('user', $ban, 0, 0, 0, $warning, $warning);
						
						$sql = 'SELECT ban_id FROM ' . BANLIST_TABLE . ' 
									WHERE ban_reason = \'' . $db-&gt;sql_escape($warning) . '\'
										AND ban_userid = ' . $user_row['user_id'];
						$result = $db-&gt;sql_query($sql);
						$user_ban_id = $db-&gt;sql_fetchfield('ban_id');
						$db-&gt;sql_freeresult($result);
						if ($user_ban_id)
						{
							$sql = 'UPDATE ' . USERS_TABLE . &quot;	SET user_ban_id = $user_ban_id
								WHERE user_id = &quot; . $user_row['user_id'];
							$db-&gt;sql_query($sql);
							$msg .= '&lt;br /&gt;&lt;br /&gt;' . $user-&gt;lang['BAN_UPDATE_SUCCESSFUL'];
						}
						$email_template = 'warning_ban_by_warning';
					}
				}
				// Notify user about warning/ban
				if ($notify)
				{
					$user-&gt;add_lang('acp/ban');
					$length = get_warning_end($warn_len, $warn_len_other);
					$assign_vars_array = array(
						'USERNAME'			=&gt; htmlspecialchars_decode($user_row['username']),
						'TO_USERNAME'		=&gt; htmlspecialchars_decode($user_row['username']),
						'FROM_USERNAME'		=&gt; htmlspecialchars_decode($user-&gt;data['username']),
						'WARNINGS_COUNT'	=&gt; htmlspecialchars_decode($config['warnings_for_ban']),
						'WARNING'			=&gt; htmlspecialchars_decode($warning),
						'WARNING_POSTER'	=&gt; htmlspecialchars_decode($user-&gt;data['username']),
						'WARNING_LENGTH'	=&gt; ($length) ? htmlspecialchars_decode($user-&gt;format_date($length, $user_row['user_dateformat'])) : htmlspecialchars_decode($user-&gt;lang['PERMANENT']),
						'WARNING_TYPE'		=&gt; ($warn_type == BAN) ? htmlspecialchars_decode($user-&gt;lang['BAN']) : htmlspecialchars_decode($user-&gt;lang['WARNING']),
						
						'WARNING_TYPE_OLD'	=&gt; ($warning_id) ? (($warning_row['warning_type'] == BAN) ? htmlspecialchars_decode($user-&gt;lang['BAN']) : htmlspecialchars_decode($user-&gt;lang['WARNING'])) : '',
						'WARNING_LENGTH_OLD'=&gt; ($warning_id) ? (($warning_row['warning_end']) ? htmlspecialchars_decode($user-&gt;format_date($warning_row['warning_end'], $user_row['user_dateformat'])) : htmlspecialchars_decode($user-&gt;lang['PERMANENT'])) : '',
						'WARNING_OLD'		=&gt; (isset($warning_edit[0])) ? $warning_edit[0] : '',
					);
					user_notify($email_template, $user_row, $assign_vars_array);
				}
</action>
            </edit>
            <edit>
                <find>		$template-&gt;assign_vars(array(</find>
                <action type="before-add">		if(isset($warning_row['warning_type']))
		{
			select_warn_type($warning_row['warning_type']);
		}
		else
		{
			select_warn_type();
		}

		if(isset($warning_row['warning_end']) &amp;&amp; $warning_row['warning_end'])
		{
			display_warn_options('-1');
		}
		else
		{
			display_warn_options();
		}

</action>
            </edit>
            <edit>
                <find>			'WARNINGS'			=&gt; ($user_row['user_warnings']) ? $user_row['user_warnings'] : 0,</find>
                <action type="after-add">			'WARNING'			=&gt; (isset($warning_edit[0])) ? $warning_edit[0] : '',
			'WARNING_ID'		=&gt; (isset($warning_row['warning_id'])) ? $warning_row['warning_id'] : '',
			'WARNING_END'		=&gt; (isset($warning_row['warning_end'])) ? (($warning_row['warning_end']) ? $user-&gt;format_date($warning_row['warning_end'], 'Y-m-d') : '') : '',

</action>
            </edit>
            <edit>
                <find>		$warning = utf8_normalize_nfc(request_var('warning', '', true));</find>
                <action type="after-add">		$warn_len = request_var('warnlength', 0);
		$warn_len_other	= request_var('warnlengthother', '');
		$warn_type = request_var('warntype', WARNING);
		$warning_id = request_var('warn_id', 0);

</action>
            </edit>
            <edit>
                <find>		// Prevent someone from warning themselves
		if ($user_row['user_id'] == $user-&gt;data['user_id'])
		{
			trigger_error('CANNOT_WARN_SELF');
		}
</find>
                <action type="after-add">		// Prevent someone from warning founder
		if ($user_row['user_type'] == USER_FOUNDER)
		{
			trigger_error('CANNOT_WARN_FOUNDER');
		}
</action>
            </edit>
            <edit>
                <find>		$user_id = $user_row['user_id'];</find>
                <action type="after-add">		$warning_edit = array();
		if ($warning_id)
		{
			$sql = 'SELECT w.*, l.log_data
				FROM ' . WARNINGS_TABLE . ' w, ' . LOG_TABLE . &quot; l 
				WHERE w.warning_id = '$warning_id'
					AND l.log_id = w.log_id&quot;;
			$result = $db-&gt;sql_query($sql);
			$warning_row = $db-&gt;sql_fetchrow($result);
			$db-&gt;sql_freeresult($result);

			if (!$warning_row)
			{
				trigger_error('NO_WARNING');
			}
			
			if (!$warning_row['warning_status'])
			{
				trigger_error('WARNING_EXPIRED');
			}
			
			$warning_edit = unserialize($warning_row['log_data']);
		}

</action>
            </edit>
            <edit>
                <find>		if ($warning &amp;&amp; $action == 'add_warning')</find>
                <action type="before-add">		
		if (!$warning_id &amp;&amp; !$user_row['user_ban_id'] &amp;&amp; ($user_row['user_warnings'] + 1 == $config['warnings_for_ban']))
		{
			$warn_type = WARNING_BAN;
			$warning = sprintf($user-&gt;lang['WARNING_BAN'], ($user_row['user_warnings'] + 1), $warning);
		}

</action>
            </edit>
            <edit>
                <find>				add_warning($user_row, $warning, $notify);
				$msg = $user-&gt;lang['USER_WARNING_ADDED'];
</find>
                <action type="replace-with">				if(!function_exists('user_ban'))
				{
					include_once($phpbb_root_path . 'includes/functions_user.' . $phpEx);
				}
				if ($warning_id)
				{
					edit_warning($warning_row, $user_row, $warning, $warn_len, $warn_len_other, $warn_type);
					$msg = $user-&gt;lang['USER_WARNING_EDITED'] . (($warn_type == BAN) ? '&lt;br /&gt;&lt;br /&gt;' . $user-&gt;lang['BAN_UPDATE_SUCCESSFUL'] : '');
					$email_template = 'warning_edited';
				}
				else
				{
					add_warning($user_row, $warning, $warn_len, $warn_len_other, $warn_type, $notify);
					$msg = $user-&gt;lang['USER_WARNING_ADDED'];
					$email_template = 'warning_user';

					if ($warn_type == BAN)
					{
						$ban = utf8_normalize_nfc($user_row['username']);
						user_ban('user', $ban, $warn_len, $warn_len_other, 0, $warning, $warning);
						$msg .= '&lt;br /&gt;&lt;br /&gt;' . $user-&gt;lang['BAN_UPDATE_SUCCESSFUL'];
						$email_template = 'warning_user_ban';
					}
					else if ($warn_type == WARNING_BAN)
					{
						$ban = utf8_normalize_nfc($user_row['username']);
						user_ban('user', $ban, 0, 0, 0, $warning, $warning);
						
						$sql = 'SELECT ban_id FROM ' . BANLIST_TABLE . ' 
									WHERE ban_reason = \'' . $db-&gt;sql_escape($warning) . '\'
										AND ban_userid = ' . $user_row['user_id'];
						$result = $db-&gt;sql_query($sql);
						$user_ban_id = $db-&gt;sql_fetchfield('ban_id');
						$db-&gt;sql_freeresult($result);
						if ($user_ban_id)
						{
							$sql = 'UPDATE ' . USERS_TABLE . &quot;	SET user_ban_id = $user_ban_id
								WHERE user_id = &quot; . $user_row['user_id'];
							$db-&gt;sql_query($sql);
							$msg .= '&lt;br /&gt;&lt;br /&gt;' . $user-&gt;lang['BAN_UPDATE_SUCCESSFUL'];
						}
						$email_template = 'warning_ban_by_warning';
					}
				}
				// Notify user about warning/ban
				if ($notify)
				{
					$user-&gt;add_lang('acp/ban');
					$length = get_warning_end($warn_len, $warn_len_other);
					$assign_vars_array = array(
						'USERNAME'			=&gt; htmlspecialchars_decode($user_row['username']),
						'TO_USERNAME'		=&gt; htmlspecialchars_decode($user_row['username']),
						'FROM_USERNAME'		=&gt; htmlspecialchars_decode($user-&gt;data['username']),
						'WARNINGS_COUNT'	=&gt; htmlspecialchars_decode($config['warnings_for_ban']),
						'WARNING'			=&gt; htmlspecialchars_decode($warning),
						'WARNING_POSTER'	=&gt; htmlspecialchars_decode($user-&gt;data['username']),
						'WARNING_LENGTH'	=&gt; ($length) ? htmlspecialchars_decode($user-&gt;format_date($length, $user_row['user_dateformat'])) : htmlspecialchars_decode($user-&gt;lang['PERMANENT']),
						'WARNING_TYPE'		=&gt; ($warn_type == BAN) ? htmlspecialchars_decode($user-&gt;lang['BAN']) : htmlspecialchars_decode($user-&gt;lang['WARNING']),
						
						'WARNING_TYPE_OLD'	=&gt; ($warning_id) ? (($warning_row['warning_type'] == BAN) ? htmlspecialchars_decode($user-&gt;lang['BAN']) : htmlspecialchars_decode($user-&gt;lang['WARNING'])) : '',
						'WARNING_LENGTH_OLD'=&gt; ($warning_id) ? (($warning_row['warning_end']) ? htmlspecialchars_decode($user-&gt;format_date($warning_row['warning_end'], $user_row['user_dateformat'])) : htmlspecialchars_decode($user-&gt;lang['PERMANENT'])) : '',
						'WARNING_OLD'		=&gt; (isset($warning_edit[0])) ? $warning_edit[0] : '',
					);
					user_notify($email_template, $user_row, $assign_vars_array);
				}
</action>
            </edit>
            <edit>
                <find>		// OK, they didn't submit a warning so lets build the page for them to do so</find>
                <action type="before-add">		if(isset($warning_row['warning_type']))
		{
			select_warn_type($warning_row['warning_type']);
		}
		else
		{
			select_warn_type();
		}

		if(isset($warning_row['warning_end']) &amp;&amp; $warning_row['warning_end'])
		{
			display_warn_options('-1');
		}
		else
		{
			display_warn_options();
		}

</action>
            </edit>
            <edit>
                <find>			'WARNINGS'			=&gt; ($user_row['user_warnings']) ? $user_row['user_warnings'] : 0,</find>
                <action type="after-add">			'WARNING'			=&gt; (isset($warning_edit[0])) ? $warning_edit[0] : '',
			'WARNING_ID'		=&gt; (isset($warning_row['warning_id'])) ? $warning_row['warning_id'] : '',
			'WARNING_END'		=&gt; (isset($warning_row['warning_end'])) ? (($warning_row['warning_end']) ? $user-&gt;format_date($warning_row['warning_end'], 'Y-m-d') : '') : '',

</action>
            </edit>
            <edit>
                <find>function add_warning($user_row, $warning, $send_pm = true, $post_id = 0)</find>
                <action type="replace-with">function add_warning($user_row, $warning, $warn_len, $warn_len_other, $warn_type = WARNING, $send_pm = true, $post_id = 0)</action>
            </edit>
            <edit>
                <find>	global $template, $db, $user, $auth;</find>
                <action type="replace-with">	global $template, $db, $user, $auth, $cache;</action>
            </edit>
            <edit>
                <find>	if ($send_pm)</find>
                <action type="before-add">	
	if(!in_array($warn_type, array(WARNING, BAN)))
	{
		$warn_type = WARNING;
	}

	$warn_end = get_warning_end($warn_len, $warn_len_other);
</action>
            </edit>
            <edit>
                <find>		'warning_time'	=&gt; time(),</find>
                <action type="after-add">		'warning_end'	=&gt; (int) $warn_end,
		'warning_type'	=&gt; $warn_type,
</action>
            </edit>
            <edit>
                <find>	// We add this to the mod log too for moderators to see that a specific user got warned.</find>
                <action type="before-add">	$cache-&gt;destroy('sql', WARNINGS_TABLE);</action>
            </edit>
            <edit>
                <find>?&gt;</find>
                <action type="before-add">/**
* Insert the edited warning into the database
*/
function edit_warning($warning_row, $user_row, $warning, $warn_len, $warn_len_other, $warn_type)
{
	global $db, $cache;

	if(!isset($warning_row) || empty($warning_row))
	{
		return false;
	}
	
	$warn_end = get_warning_end($warn_len, $warn_len_other);

	$warning_type_change = false;
	if($warning_row['warning_type'] != $warn_type &amp;&amp; in_array($warn_type, array(WARNING, BAN)))
	{
		$warning_type_change = true;
	}

	$sql_warn_ary = array(
		'warning_end'	=&gt; (int) $warn_end,
		'warning_type'	=&gt; $warn_type,
	);
	
	$sql_log_ary = array(
		'log_data'	=&gt; serialize(array($warning)),
	);

	if ($warning_row['warning_type'] == BAN)
	{
		$sql = 'SELECT ban_id FROM ' . BANLIST_TABLE . ' 
					WHERE ban_userid = ' . $warning_row['user_id'] . ' 
						AND ban_end = ' . $warning_row['warning_end'];
		$result = $db-&gt;sql_query($sql);
		$ban_id = $db-&gt;sql_fetchfield('ban_id');
		$db-&gt;sql_freeresult($result);
	
		if (!$warning_type_change &amp;&amp; $ban_id)
		{
			$sql_ban_ary = array(
				'ban_end'			=&gt; (int) $warn_end,
				'ban_reason'		=&gt; (string) $warning,
				'ban_give_reason'	=&gt; (string) $warning,
			);
			$sql = 'UPDATE ' . BANLIST_TABLE . ' SET ' . $db-&gt;sql_build_array('UPDATE', $sql_ban_ary) . ' WHERE ban_id = ' . $ban_id;
			$db-&gt;sql_query($sql);
		}
	}

	if ($warning_type_change)
	{
		if ($warn_type == WARNING &amp;&amp; $ban_id)
		{
			user_unban('user', $ban_id);
		}
		elseif ($warn_type == BAN)
		{ 
			$ban = utf8_normalize_nfc($user_row['username']);
			user_ban('user', $ban, $warn_len, $warn_len_other, 0, $warning, $warning);		
		}
	}

	// Update warning information - submit new warning and log data to database
	$sql = 'UPDATE ' . WARNINGS_TABLE . ' SET ' . $db-&gt;sql_build_array('UPDATE', $sql_warn_ary) . ' WHERE warning_id = ' . $warning_row['warning_id'];
	$db-&gt;sql_query($sql);

	$sql = 'UPDATE ' . LOG_TABLE . ' SET ' . $db-&gt;sql_build_array('UPDATE', $sql_log_ary) . ' WHERE log_id = ' . $warning_row['log_id'];
	$db-&gt;sql_query($sql);

	$cache-&gt;destroy('sql', WARNINGS_TABLE);

}

/**
* Display warning options
*/
function display_warn_options($default = 0)
{
	global $user, $template;

	// Ban length options
	$warn_end_text = array(0 =&gt; $user-&gt;lang['PERMANENT'], 30 =&gt; $user-&gt;lang['30_MINS'], 60 =&gt; $user-&gt;lang['1_HOUR'], 360 =&gt; $user-&gt;lang['6_HOURS'], 1440 =&gt; $user-&gt;lang['1_DAY'], 10080 =&gt; $user-&gt;lang['7_DAYS'], 20160 =&gt; $user-&gt;lang['2_WEEKS'], 40320 =&gt; $user-&gt;lang['1_MONTH'], -1 =&gt; $user-&gt;lang['UNTIL'] . ' -&amp;gt; ');

	$warn_end_options = '';
	foreach ($warn_end_text as $length =&gt; $text)
	{
		$selected = ($length == $default) ? ' selected=&quot;selected&quot;' : '';
		$warn_end_options .= '&lt;option value=&quot;' . $length . '&quot;' . $selected . '&gt;' . $text . '&lt;/option&gt;';
	}
	
	$template-&gt;assign_vars(array(
		'S_WARN_END_OPTIONS'	=&gt; $warn_end_options)
	);
}

/**
* Select warning type (warning/quick ban)
*/
function select_warn_type($default = WARNING)
{
	global $auth, $user, $template;

	// Warning type options
	$warn_type_text = array(WARNING =&gt; $user-&gt;lang['WARNING'], BAN =&gt; $user-&gt;lang['BAN']);

	if(!$auth-&gt;acl_get('m_ban'))
	{
		unset($warn_type_text[BAN]);
	}

	$warn_type_options = '';
	foreach ($warn_type_text as $type =&gt; $text)
	{
		$selected = ($type == $default) ? ' selected=&quot;selected&quot;' : '';
		$warn_type_options .= '&lt;option value=&quot;' . $type . '&quot;' . $selected . '&gt;' . $text . '&lt;/option&gt;';
	}
	
	$template-&gt;assign_vars(array(
		'S_WARN_TYPE_OPTIONS'	=&gt; $warn_type_options)
	);
}

/**
* Determine warning end time
*/
function get_warning_end($warn_len, $warn_len_other)
{
	$current_time = time();

	// Set $warn_end to the unix time when the ban should end. 0 is a permanent warning.
	if ($warn_len)
	{
		if ($warn_len != -1 || !$warn_len_other)
		{
			$warn_end = max($current_time, $current_time + ($warn_len) * 60);
		}
		else
		{
			$warn_other = explode('-', $warn_len_other);
			if (sizeof($warn_other) == 3 &amp;&amp; ((int)$warn_other[0] &lt; 9999) &amp;&amp;
				(strlen($warn_other[0]) == 4) &amp;&amp; (strlen($warn_other[1]) == 2) &amp;&amp; (strlen($warn_other[2]) == 2))
			{
				$warn_end = max($current_time, gmmktime(0, 0, 0, (int)$warn_other[1], (int)$warn_other[2], (int)$warn_other[0]));
			}
			else
			{
				trigger_error('LENGTH_WARNING_INVALID');
			}
		}
	}
	else
	{
		$warn_end = 0;
	}
	
	return $warn_end;
}

/**
* User notify function
*/
function user_notify($email_template = '', $user_row, $assign_vars_array, $anti_abuse_headers = false, $use_queue = false)
{
	global $phpbb_root_path, $phpEx, $user, $config;

	$notify_method = $user_row['user_notify_type'];
	if (!$config['email_enable'] &amp;&amp; $user_row['user_jabber'])
	{
		$notify_method = NOTIFY_IM;
	}
	else if (!$config['email_enable'])
	{
		return false;
	}

	if (empty($email_template))
	{
		return false;
	}
	
	include_once($phpbb_root_path . 'includes/functions_messenger.' . $phpEx);
	$messenger = new messenger($use_queue);

	$messenger-&gt;template($email_template, $user_row['user_lang']);
	$messenger-&gt;to($user_row['user_email'], $user_row['username']);
	$messenger-&gt;im($user_row['user_jabber'], $user_row['username']);
	$messenger-&gt;assign_vars($assign_vars_array);
	
	if ($anti_abuse_headers)
	{
		$messenger-&gt;headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
		$messenger-&gt;headers('X-AntiAbuse: User_id - ' . $user-&gt;data['user_id']);
		$messenger-&gt;headers('X-AntiAbuse: Username - ' . $user-&gt;data['username']);
		$messenger-&gt;headers('X-AntiAbuse: User IP - ' . $user-&gt;ip);
	}
	
	$messenger-&gt;send($notify_method);
	
	if ($use_queue)
	{
		$messenger-&gt;save_queue();
	}
	
	return true;
}
</action>
            </edit>
        </open>
        <open src="styles/prosilver/template/mcp_warn_list.html">
            <edit>
                <find>&lt;h2&gt;{L_WARNED_USERS}&lt;/h2&gt;</find>
                <action type="replace-with">&lt;h2&gt;{L_WARNINGS}&lt;/h2&gt;</action>
            </edit>
            <edit>
                <find>	&lt;p&gt;{L_WARNED_USERS_EXPLAIN}&lt;/p&gt;</find>
                <action type="replace-with">	&lt;p&gt;{L_WARNINGS_EXPLAIN}&lt;/p&gt;</action>
            </edit>
            <edit>
                <find>				&lt;!-- IF TOTAL_USERS --&gt;{TOTAL_USERS} &lt;!-- ENDIF --&gt;</find>
                <action type="replace-with">				&lt;!-- IF TOTAL_WARNINGS --&gt;{TOTAL_WARNINGS} &lt;!-- ENDIF --&gt;</action>
            </edit>
            <edit>
                <find>				&lt;th class=&quot;name&quot;&gt;{L_WARNINGS}&lt;/th&gt;
				&lt;th class=&quot;name&quot;&gt;{L_LATEST_WARNING_TIME}&lt;/th&gt;
</find>
                <action type="replace-with">				&lt;th class=&quot;name&quot;&gt;{L_WARNING_TIME}&lt;/th&gt;
				&lt;th class=&quot;name&quot;&gt;{L_WARNING_EXPIRES}&lt;/th&gt;
				&lt;th&gt;&lt;/th&gt;

</action>
            </edit>
            <edit>
                <find>				&lt;td&gt;&lt;a href=&quot;{user.U_NOTES}&quot;&gt;{L_VIEW_NOTES}&lt;/a&gt;&lt;/td&gt;</find>
                <action type="replace-with">				&lt;td&gt;&lt;!-- IF user.U_WARNING_POST_URL --&gt;&lt;a href=&quot;{user.U_WARNING_POST_URL}&quot;&gt;{L_WARNING_POST}&lt;/a&gt;&lt;!-- ELSE --&gt;&amp;nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
				&lt;td&gt;&lt;!-- IF user.WARNING_STATUS --&gt;&lt;a href=&quot;{user.U_EDIT}&quot;&gt;{L_EDIT_WARNING}&lt;/a&gt;&lt;!-- ELSE --&gt;{L_WARNING_EXPIRED}&lt;!-- ENDIF --&gt;&lt;/td&gt;

</action>
            </edit>
            <edit>
                <find>				&lt;!-- IF TOTAL_USERS --&gt;{TOTAL_USERS} &lt;!-- ENDIF --&gt;</find>
                <action type="replace-with">				&lt;!-- IF TOTAL_WARNINGS --&gt;{TOTAL_WARNINGS} &lt;!-- ENDIF --&gt;</action>
            </edit>
        </open>
        <open src="styles/prosilver/template/mcp_warn_post.html">
            <edit>
                <find>		&lt;textarea name=&quot;warning&quot; id=&quot;warning&quot; class=&quot;inputbox&quot; cols=&quot;40&quot; rows=&quot;3&quot;&gt;{L_WARNING_POST_DEFAULT}&lt;/textarea&gt;</find>
                <action type="replace-with">		&lt;dl&gt;
			&lt;dt&gt;&lt;label for=&quot;warntype&quot;&gt;{L_WARNING_TYPE}&lt;/label&gt;&lt;/dt&gt;
			&lt;dd&gt;&lt;label for=&quot;warntype&quot;&gt;&lt;select name=&quot;warntype&quot; id=&quot;warntype&quot;&gt;{S_WARN_TYPE_OPTIONS}&lt;/select&gt;&lt;/label&gt;&lt;/dd&gt;
			&lt;dt&gt;&lt;label for=&quot;warnlength&quot;&gt;{L_WARNING_EXPIRES}&lt;/label&gt;&lt;/dt&gt;
			&lt;dd&gt;&lt;label for=&quot;warnlength&quot;&gt;&lt;select name=&quot;warnlength&quot; id=&quot;warnlength&quot; onchange=&quot;if(this.value==-1){document.getElementById('warnlengthother').style.display = 'block';}else{document.getElementById('warnlengthother').style.display='none';}&quot;&gt;{S_WARN_END_OPTIONS}&lt;/select&gt;&lt;/label&gt;&lt;/dd&gt;
			&lt;dd id=&quot;warnlengthother&quot; &lt;!-- IF not WARNING_END --&gt;style=&quot;display: none;&quot;&lt;!-- ENDIF --&gt;&gt;&lt;label&gt;&lt;input type=&quot;text&quot; name=&quot;warnlengthother&quot; class=&quot;inputbox&quot; &lt;!-- IF WARNING_END --&gt;value=&quot;{WARNING_END}&quot;&lt;!-- ENDIF --&gt;  /&gt;&lt;br /&gt;&lt;span&gt;{L_YEAR_MONTH_DAY}&lt;/span&gt;&lt;/label&gt;&lt;/dd&gt;
		&lt;/dl&gt;
		&lt;textarea name=&quot;warning&quot; id=&quot;warning&quot; class=&quot;inputbox&quot; cols=&quot;40&quot; rows=&quot;3&quot;&gt;&lt;!-- IF WARNING --&gt;{WARNING}&lt;!-- ELSE --&gt;{L_WARNING_POST_DEFAULT}&lt;!-- ENDIF --&gt;&lt;/textarea&gt;
</action>
            </edit>
            <edit>
                <find>	{S_FORM_TOKEN}</find>
                <action type="before-add">	&lt;!-- IF WARNING_ID --&gt;&lt;input type="hidden" name="warn_id" value="{WARNING_ID}" /&gt;&lt;!-- ENDIF --&gt;</action>
            </edit>
        </open>
        <open src="styles/prosilver/template/mcp_warn_user.html">
            <edit>
                <find>		&lt;textarea name=&quot;warning&quot; id=&quot;warning&quot; class=&quot;inputbox&quot; cols=&quot;40&quot; rows=&quot;3&quot;&gt;&lt;/textarea&gt;</find>
                <action type="replace-with">		&lt;dl&gt;
			&lt;dt&gt;&lt;label for=&quot;warntype&quot;&gt;{L_WARNING_TYPE}&lt;/label&gt;&lt;/dt&gt;
			&lt;dd&gt;&lt;label for=&quot;warntype&quot;&gt;&lt;select name=&quot;warntype&quot; id=&quot;warntype&quot;&gt;{S_WARN_TYPE_OPTIONS}&lt;/select&gt;&lt;/label&gt;&lt;/dd&gt;
			&lt;dt&gt;&lt;label for=&quot;warnlength&quot;&gt;{L_WARNING_EXPIRES}&lt;/label&gt;&lt;/dt&gt;
			&lt;dd&gt;&lt;label for=&quot;warnlength&quot;&gt;&lt;select name=&quot;warnlength&quot; id=&quot;warnlength&quot; onchange=&quot;if(this.value==-1){document.getElementById('warnlengthother').style.display = 'block';}else{document.getElementById('warnlengthother').style.display='none';}&quot;&gt;{S_WARN_END_OPTIONS}&lt;/select&gt;&lt;/label&gt;&lt;/dd&gt;
			&lt;dd id=&quot;warnlengthother&quot; &lt;!-- IF not WARNING_END --&gt;style=&quot;display: none;&quot;&lt;!-- ENDIF --&gt;&gt;&lt;label&gt;&lt;input type=&quot;text&quot; name=&quot;warnlengthother&quot; class=&quot;inputbox&quot; &lt;!-- IF WARNING_END --&gt;value=&quot;{WARNING_END}&quot;&lt;!-- ENDIF --&gt; /&gt;&lt;br /&gt;&lt;span&gt;{L_YEAR_MONTH_DAY}&lt;/span&gt;&lt;/label&gt;&lt;/dd&gt;
		&lt;/dl&gt;
		&lt;textarea name=&quot;warning&quot; id=&quot;warning&quot; class=&quot;inputbox&quot; cols=&quot;40&quot; rows=&quot;3&quot;&gt;&lt;!-- IF WARNING --&gt;{WARNING}&lt;!-- ENDIF --&gt;&lt;/textarea&gt;
</action>
            </edit>
            <edit>
                <find>	{S_FORM_TOKEN}</find>
                <action type="before-add">	&lt;!-- IF WARNING_ID --&gt;&lt;input type="hidden" name="warn_id" value="{WARNING_ID}" /&gt;&lt;!-- ENDIF --&gt;</action>
            </edit>
        </open>
        <open src="styles/prosilver/template/memberlist_view.html">
            <edit>
                <find>&lt;/form&gt;</find>
                <action type="before-add">&lt;!-- IF .user --&gt;
&lt;div&gt;
&lt;div class="panel bg2"&gt;
	&lt;div class="inner"&gt;&lt;span class="corners-top"&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;
		&lt;h3&gt;{L_WARNINGS}&lt;/h3&gt;
		&lt;table class="table1" cellspacing="0"&gt;
			&lt;thead&gt;
				&lt;tr&gt;
					&lt;th class="simplename"&gt;{L_AUTHOR}&lt;/th&gt;
					&lt;th class="simplename"&gt;{L_WARNING_TIME}&lt;/th&gt;
					&lt;th class="simplename"&gt;{L_WARNING_EXPIRES}&lt;/th&gt;
					&lt;th class="simplename"&gt;{L_REASON}&lt;/th&gt;
					&lt;th&gt;&lt;/th&gt;
					&lt;th&gt;&lt;/th&gt;
				&lt;/tr&gt;
			&lt;/thead&gt;
			&lt;tbody&gt;

			&lt;!-- BEGIN user --&gt;
				&lt;tr class="&lt;!-- IF user.S_ROW_COUNT is even --&gt;bg1&lt;!-- ELSE --&gt;bg2&lt;!-- ENDIF --&gt;"&gt;
					&lt;td&gt;{user.USERNAME_FULL}&lt;/td&gt;
					&lt;td&gt;{user.WARNINGS}&lt;/td&gt;
					&lt;td&gt;{user.WARNING_TIME}&lt;/td&gt;
					&lt;td style="width:40%;"&gt;{user.WARNING}&lt;/td&gt;
					&lt;td&gt;&lt;!-- IF user.U_WARNING_POST_URL --&gt;&lt;a href="{user.U_WARNING_POST_URL}"&gt;{L_WARNING_POST}&lt;/a&gt;&lt;!-- ELSE --&gt; &lt;!-- ENDIF --&gt;&lt;/td&gt;
					&lt;td&gt;&lt;!-- IF user.WARNING_STATUS --&gt;&lt;a href="{user.U_EDIT}"&gt;{L_EDIT_WARNING}&lt;/a&gt;&lt;!-- ELSE --&gt;{L_WARNING_EXPIRED}&lt;!-- ENDIF --&gt;&lt;/td&gt;
				&lt;/tr&gt;
			&lt;!-- END user --&gt;
			&lt;/tbody&gt;
		&lt;/table&gt;
	
	&lt;span class="corners-bottom"&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;!-- ENDIF --&gt;</action>
            </edit>
        </open>
        <open src="styles/prosilver/template/viewtopic_body.html">
            <edit>
                <find>			&lt;!-- IF postrow.BUMPED_MESSAGE --&gt;&lt;div class=&quot;notice&quot;&gt;{postrow.BUMPED_MESSAGE}&lt;/div&gt;&lt;!-- ENDIF --&gt;</find>
                <action type="before-add">			&lt;!-- IF postrow.WARNING --&gt;&lt;div class=&quot;notice&quot;&gt;&lt;strong&gt;&lt;!-- IF postrow.WARNING_TYPE eq 1 --&gt;{L_BAN}&lt;!-- ELSE --&gt;{L_WARNING}&lt;!-- ENDIF --&gt;:&lt;/strong&gt; {postrow.WARNING_POSTER} {postrow.WARNING_TIME}&lt;br /&gt;&lt;strong&gt;{L_REASON}:&lt;/strong&gt; &lt;em&gt;{postrow.WARNING}&lt;/em&gt;&lt;/div&gt;&lt;!-- ENDIF --&gt;</action>
            </edit>
            <edit>
                <find>		&lt;!-- IF postrow.POSTER_FROM --&gt;&lt;dd&gt;&lt;strong&gt;{L_LOCATION}:&lt;/strong&gt; {postrow.POSTER_FROM}&lt;/dd&gt;&lt;!-- ENDIF --&gt;</find>
                <action type="after-add">		&lt;!-- IF postrow.POSTER_BANNED --&gt;&lt;br /&gt;&lt;dd style="background-color: #ECD5D8;"&gt;&lt;strong&gt;{L_BANNED}:&lt;/strong&gt; {postrow.POSTER_BAN_END}&lt;!-- ELSEIF postrow.POSTER_WARNINGS --&gt;&lt;dd style="background-color: #FFFF99;"&gt;&lt;strong&gt;{L_WARNINGS}:&lt;/strong&gt; {postrow.POSTER_WARNINGS}&lt;/dd&gt;&lt;!-- ENDIF --&gt;</action>
            </edit>
        </open>
        <open src="styles/prosilver/theme/common.css">
            <edit>
                <find>table.table1 thead .autocol { padding-left: 1em; }</find>
                <action type="after-add">table.table1 .simplename	{	color: #333333;	font-weight: bold;	padding: 5px;text-align: left; }</action>
            </edit>
        </open>
        <diy-instructions lang="en">Purge the cache and refresh the theme through ACP.</diy-instructions>
    </action-group>
</mod>
